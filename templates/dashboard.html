<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Net Worth Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav>
        <a href="{{ url_for('index') }}">Home</a>
        <a href="{{ url_for('dashboard') }}">Dashboard</a>
        <button id="refreshBtn" title="Refresh data" aria-label="Refresh data">⟳</button>
    </nav>
    <h1>Net Worth Dashboard</h1>
    <div class="summary">
        <div class="summary-item">
            <h3>Total Assets</h3>
            <p class="positive">£{{ "{:,.2f}".format(summary_data['total_assets']) }}</p>
        </div>
        <div class="summary-item">
            <h3>Total Debts</h3>
            <p class="negative">£{{ "{:,.2f}".format(summary_data['total_debts']) }}</p>
        </div>
        <div class="summary-item">
            <h3>Net Worth</h3>
            <p class="{{ 'positive' if summary_data['net_worth'] >= 0 else 'negative' }}">
                £{{ "{:,.2f}".format(summary_data['net_worth']) }}
            </p>
        </div>
    </div>
    <div class="pie-chart-container">
        <canvas id="pieChart"></canvas>
    </div>
    <div class="details">
        <div class="assets">
            <h2>Assets</h2>
            <ul>
                {% for type, value in summary_data['latest_data'].items() %}
                    {% if summary_data['type_categories'].get(type) == 'Asset' %}
                        <li>{{ type }}: £{{ "{:,.2f}".format(value) }}</li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
        <div class="debts">
            <h2>Debts</h2>
            <ul>
                {% for type, value in summary_data['latest_data'].items() %}
                    {% if summary_data['type_categories'].get(type) == 'Debt' %}
                        <li>{{ type }}: £{{ "{:,.2f}".format(value) }}</li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
    </div>
    <script>
        document.getElementById('refreshBtn').addEventListener('click', async function() {
            this.disabled = true;
            try {
                const res = await fetch('{{ url_for('refresh_cache') }}', { method: 'POST' });
                if (res.ok) {
                    location.reload();
                } else {
                    alert('Failed to refresh cache');
                }
            } catch (e) {
                alert('Error refreshing cache');
            } finally {
                this.disabled = false;
            }
        });
        var ctx = document.getElementById('pieChart').getContext('2d');
        var chart = new Chart(ctx, {
            type: 'pie',
            data: {{ summary_data['pie_data'] | tojson }},
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Assets and Debts Distribution'
                    }
                }
            }
        });
    </script>
</body>
</html>
